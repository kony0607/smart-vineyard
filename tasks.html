<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>タスク管理 - Smart Vineyard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .small { font-size: .85rem }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased p-6">
  <div class="max-w-4xl mx-auto">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">タスク管理</h1>
      <div class="flex items-center gap-3">
        <a href="web.html" class="text-sm text-gray-600 hover:text-brand-main">← ポートフォリオへ戻る</a>
      </div>
    </header>

    <section class="bg-white p-6 rounded-lg shadow">
      <div class="flex gap-3 mb-4">
        <input id="taskInput" class="flex-1 border rounded px-3 py-2" placeholder="新しいタスクを入力" />
        <button id="addBtn" class="px-4 py-2 bg-brand-main text-white rounded">追加</button>
      </div>

      <div class="flex gap-3 items-center mb-4">
        <label class="flex items-center gap-2 small"><input type="checkbox" id="hideCompleted" /> 完了タスクを非表示</label>
        <button id="exportBtn" class="px-3 py-1 border rounded small">JSON エクスポート</button>
        <input id="importFile" type="file" accept="application/json" class="text-sm" />
      </div>

      <div id="taskList" class="space-y-3"></div>
    </section>
  </div>

  <script>
    const STORAGE_KEY = 'sv_tasks_v1';
    let tasks = [];

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); }
    function load(){ const s = localStorage.getItem(STORAGE_KEY); tasks = s ? JSON.parse(s) : []; }

    function id(){ return Date.now() + Math.floor(Math.random()*1000); }

    function render(){
      const hide = document.getElementById('hideCompleted').checked;
      const container = document.getElementById('taskList');
      container.innerHTML = '';

      // compute parent progress
      const childrenMap = {};
      tasks.forEach(t => { if(t.parent) { childrenMap[t.parent] = childrenMap[t.parent] || []; childrenMap[t.parent].push(t); } });

      const top = tasks.filter(t => !t.parent).sort((a,b)=>a.order-b.order);

      top.forEach(t => {
        if(hide && t.completed) return;
        const el = document.createElement('div');
        el.className = 'p-3 border rounded flex items-start gap-3 bg-white';
        const progress = (()=>{
          const kids = childrenMap[t.id] || [];
          if(kids.length===0) return t.completed?100:0;
          const done = kids.filter(c=>c.completed).length;
          return Math.round(done/kids.length*100);
        })();

        el.innerHTML = `
          <div style="width:10px"></div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <button data-id="${t.id}" class="toggleBtn text-xl">${t.completed?'✅':'⬜'}</button>
                <div class="font-medium">${t.title}</div>
              </div>
              <div class="text-sm text-gray-500">進捗 ${progress}%</div>
            </div>
            <div class="mt-2 small text-gray-600">${t.note||''}</div>
            <div class="mt-3 flex gap-2 small">
              <button data-action="add-sub" data-id="${t.id}" class="px-2 py-1 border rounded">サブ追加</button>
              <button data-action="up" data-id="${t.id}" class="px-2 py-1 border rounded">↑</button>
              <button data-action="down" data-id="${t.id}" class="px-2 py-1 border rounded">↓</button>
              <button data-action="del" data-id="${t.id}" class="px-2 py-1 border rounded text-red-600">削除</button>
            </div>
          </div>
        `;

        container.appendChild(el);

        // children
        const kids = (childrenMap[t.id]||[]).sort((a,b)=>a.order-b.order);
        kids.forEach(k=>{
          if(hide && k.completed) return;
          const ke = document.createElement('div');
          ke.className = 'ml-8 mt-2 p-2 border rounded bg-gray-50 flex items-center justify-between';
          ke.innerHTML = `<div class="flex items-center gap-3"><button data-id="${k.id}" class="toggleBtn">${k.completed?'✅':'⬜'}</button><div>${k.title}</div></div><div class="small"><button data-action="del" data-id="${k.id}" class="text-red-600">削除</button></div>`;
          container.appendChild(ke);
        });
      });

      attachHandlers();
    }

    function attachHandlers(){
      document.querySelectorAll('.toggleBtn').forEach(b=> b.onclick = ()=>{ const id = +b.dataset.id; const t = tasks.find(x=>x.id===id); t.completed = !t.completed; save(); render(); });
      document.querySelectorAll('button[data-action]').forEach(b=> b.onclick = (e)=>{
        const id = +b.dataset.id; const action = b.dataset.action;
        const idx = tasks.findIndex(x=>x.id===id);
        if(action==='del'){ tasks = tasks.filter(x=>x.id!==id && x.parent!==id); save(); render(); }
        if(action==='add-sub'){ const title = prompt('サブタスク名'); if(title){ const o = { id:id()+1, title, completed:false, parent:id, order: Date.now() }; tasks.push(o); save(); render(); } }
        if(action==='up' && idx>0){ const other = tasks[idx-1]; [tasks[idx].order, other.order] = [other.order, tasks[idx].order]; save(); render(); }
        if(action==='down' && idx < tasks.length-1){ const other = tasks[idx+1]; [tasks[idx].order, other.order] = [other.order, tasks[idx].order]; save(); render(); }
      });
    }

    // init
    load();
    // ensure order
    tasks.forEach(t=>{ if(!t.order) t.order = t.id; });
    render();

    document.getElementById('addBtn').onclick = ()=>{
      const v = document.getElementById('taskInput').value.trim(); if(!v) return; const t = { id: id(), title: v, completed:false, parent:null, order: Date.now() }; tasks.push(t); save(); document.getElementById('taskInput').value=''; render();
    };

    document.getElementById('hideCompleted').onchange = render;

    document.getElementById('exportBtn').onclick = ()=>{
      const blob = new Blob([JSON.stringify(tasks, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'tasks.json'; a.click(); URL.revokeObjectURL(url);
    };

    document.getElementById('importFile').onchange = (e)=>{
      const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{ try{ const data = JSON.parse(r.result); if(Array.isArray(data)){ tasks = data; save(); render(); alert('インポート完了'); } else alert('不正な形式'); }catch(err){ alert('読み込み失敗'); } }; r.readAsText(f);
    };
  </script>
</body>
</html>
